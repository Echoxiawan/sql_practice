-- MySQL SQL练习题 - 仅问题

-- 1. 复杂查询 - 子查询
-- 题目1：子查询基础
-- 业务场景：电商平台需要找出所有购买过价格高于平均产品价格的产品的用户。
-- 表结构：users, orders, order_items, products
-- 问题：编写SQL查询，返回购买过价格高于平均产品价格的产品的用户名和邮箱，结果不能重复。

-- 题目2：相关子查询
-- 业务场景：营销团队需要识别那些购买频率高于平均水平的高价值用户。
-- 表结构：users, orders
-- 问题：编写SQL查询，找出下单次数超过所有用户平均下单次数的用户，返回用户名、邮箱和下单次数，按下单次数降序排列。

-- 题目3：EXISTS子查询
-- 业务场景：销售团队需要找出至少购买过一次但从未进行过退货的用户。
-- 表结构：users, orders, returns
-- 问题：编写SQL查询，返回至少有一个订单但没有任何退货记录的用户的用户名、邮箱和注册日期。

-- 题目4：多层嵌套子查询
-- 业务场景：产品团队想分析高价值订单中最受欢迎的产品类别。
-- 表结构：orders, order_items, products, product_categories
-- 问题：编写SQL查询，找出在总金额超过1000元的订单中，出现频率最高的三个产品类别。返回类别名称和出现次数，按出现次数降序排列。

-- 题目5：子查询与聚合函数结合
-- 业务场景：财务部门需要分析每月的销售情况与年度平均销售额的比较。
-- 表结构：orders, order_items
-- 问题：编写SQL查询，计算2023年每个月的总销售额，并与该年度的月平均销售额进行比较。返回月份、月销售额、年度月平均销售额和差异百分比，按月份排序。

-- 2. 多表关联
-- 题目6：内连接（INNER JOIN）
-- 业务场景：销售团队需要分析各产品类别的销售表现。
-- 表结构：product_categories, products, order_items, orders
-- 问题：编写SQL查询，统计每个产品类别的总销售额，返回类别名称和销售总额，按销售总额降序排列，只显示销售额大于10000的类别。

-- 题目7：左连接（LEFT JOIN）
-- 业务场景：库存管理团队需要分析产品库存与销售的关系。
-- 表结构：products, order_items, inventory
-- 问题：编写SQL查询，找出所有产品的销售量和当前库存比例。返回产品名称、总销售量、当前总库存量和销售/库存比例，包括没有任何销售记录的产品。

-- 题目8：右连接（RIGHT JOIN）
-- 业务场景：员工绩效评估，分析销售人员的业绩。
-- 表结构：employees, sales
-- 问题：编写SQL查询，分析销售部门所有员工（包括没有任何销售记录的员工）的销售业绩。返回员工姓名、职位、总销售额和平均佣金，按总销售额降序排列。

-- 题目9：全连接（使用LEFT JOIN + UNION + RIGHT JOIN模拟）
-- 业务场景：市场团队需要全面了解用户活动和订单之间的关系。
-- 表结构：users, orders, user_activity_logs
-- 问题：编写SQL查询，获取所有用户的活动和订单统计，包括没有活动记录的用户和没有订单的用户。返回用户名、活动次数、订单次数和最后活动日期。

-- 题目10：自连接（SELF JOIN）
-- 业务场景：人力资源部门需要生成公司的组织结构报表。
-- 表结构：employees
-- 问题：编写SQL查询，生成一个显示每个员工及其直接上级的报表。返回员工姓名、员工职位、上级姓名和上级职位。对于没有上级的员工，上级信息显示为"顶级管理者"。

-- 题目11：多表连接
-- 业务场景：全面的订单分析报告，包含用户、产品和支付信息。
-- 表结构：users, orders, order_items, products, financial_transactions
-- 问题：编写SQL查询，生成一个详细的订单报告，包含用户信息、订单日期、产品详情、支付金额和支付方式。限制结果为2023年5月的订单，按订单日期排序。

-- 3. 数据聚合
-- 题目12：基础聚合与分组
-- 业务场景：销售部门需要按季度和产品类别分析销售趋势。
-- 表结构：orders, order_items, products, product_categories
-- 问题：编写SQL查询，按季度和产品类别统计2023年的销售额，返回年份、季度、类别名称和销售总额，按季度和销售额降序排列。

-- 题目13：HAVING子句
-- 业务场景：识别高消费但评价较低的产品，可能需要质量改进。
-- 表结构：products, order_items, reviews
-- 问题：编写SQL查询，找出销售额超过10000但平均评分低于4的产品。返回产品名称、销售总额、评价数量和平均评分，按平均评分升序排列。

-- 题目14：复杂分组与聚合
-- 业务场景：分析不同用户等级在不同季节的消费模式。
-- 表结构：users, orders, order_items
-- 问题：编写SQL查询，按用户等级和季节统计消费金额。返回用户等级、季节（春、夏、秋、冬）、订单数量和总消费金额，按用户等级和总消费金额降序排列。

-- 题目15：聚合函数与CASE表达式
-- 业务场景：分析产品在不同价格段的销售表现。
-- 表结构：products, order_items
-- 问题：编写SQL查询，将产品按价格分为"低价"（<100）、"中价"（100-1000）和"高价"（>1000）三组，统计每组的产品数量、销售总额和平均销售单价，按价格组升序排列。

-- 题目16：窗口函数基础
-- 业务场景：销售团队需要分析产品销售的环比增长情况。
-- 表结构：orders, order_items, products
-- 问题：编写SQL查询，计算2023年每个月的总销售额以及与上个月相比的增长百分比。返回年月、销售额和环比增长率，按年月排序。

-- 题目17：窗口函数与排名
-- 业务场景：识别每个类别中最畅销的产品。
-- 表结构：products, order_items, product_categories
-- 问题：编写SQL查询，找出每个产品类别中销售额排名前3的产品。返回类别名称、产品名称、销售额和类别内排名，按类别名称和排名排序。

-- 题目18：累积求和窗口函数
-- 业务场景：财务团队需要分析累积销售额达成情况。
-- 表结构：orders, order_items
-- 问题：编写SQL查询，计算2023年每天的销售额和累积销售额。返回日期、当日销售额和累积销售额，按日期排序。

-- 题目19：移动平均窗口函数
-- 业务场景：销售趋势分析，平滑短期波动。
-- 表结构：orders, order_items
-- 问题：编写SQL查询，计算2023年每天的销售额和7天移动平均销售额。返回日期、当日销售额和7天移动平均值，按日期排序。

-- 题目20：窗口函数与分区比较
-- 业务场景：比较每个产品的销售额与其所属类别平均销售额的差异。
-- 表结构：products, order_items, product_categories
-- 问题：编写SQL查询，计算每个产品的销售额、所属类别的平均销售额以及与类别平均值的偏差百分比。返回产品名称、产品销售额、类别平均销售额和偏差百分比，按偏差百分比降序排列。

-- 4. 业务报表分析
-- 题目21：销售漏斗分析
-- 业务场景：电商平台需要分析用户从浏览到购买的转化漏斗。
-- 表结构：user_activity_logs, orders
-- 问题：编写SQL查询，分析2023年5月的销售漏斗，统计浏览产品、添加购物车、创建订单和完成支付的用户数量及转化率。返回每个阶段的名称、用户数量和与上一阶段的转化率。

-- 题目22：RFM客户分析
-- 业务场景：营销团队需要基于最近购买时间(Recency)、购买频率(Frequency)和消费金额(Monetary)对客户进行分类。
-- 表结构：users, orders, order_items
-- 问题：编写SQL查询，计算每个用户的最后购买日期、购买次数和总消费金额，然后根据这三个维度将用户分为"高价值"、"中价值"和"低价值"三组。返回用户ID、用户名、三个维度的值和最终分类。

-- 题目23：同比/环比增长分析
-- 业务场景：财务部门需要分析产品类别的同比和环比销售增长。
-- 表结构：orders, order_items, products, product_categories
-- 问题：编写SQL查询，计算2023年每个季度各产品类别的销售额，以及与上一季度和去年同期相比的增长率。返回年份、季度、类别名称、销售额、环比增长率和同比增长率。

-- 题目24：用户留存率分析
-- 业务场景：产品团队需要分析用户在首次使用后的留存情况。
-- 表结构：users, user_activity_logs
-- 问题：编写SQL查询，计算2023年1月新注册用户在接下来5个月内的每月留存率。返回用户注册月份、后续每个月份和相应的留存率百分比。

-- 题目25：商品组合分析
-- 业务场景：营销团队想了解哪些产品经常一起购买，以便进行捆绑销售。
-- 表结构：orders, order_items, products
-- 问题：编写SQL查询，找出在同一订单中最常一起购买的产品对。返回第一个产品名称、第二个产品名称和共同出现的次数，按共同出现次数降序排列，限制前20条结果。 